# 用户中心页面修改日志

## 2023-08-18：添加头像编辑功能优化

### 修改内容

1. 优化头像编辑交互
   - 添加悬停显示的编辑按钮
   - 优化头像预览效果
   - 添加文件选择和上传功能分离

2. 改进头像上传体验
   - 增加文件类型和大小验证
   - 添加上传状态反馈
   - 优化对话框布局和样式

3. 强化数据验证
   - 添加文件类型检查，限制为图片格式
   - 限制文件大小不超过500KB
   - 添加友好的错误提示信息

### 技术细节

- 交互优化：
  - 头像容器添加相对定位
  - 编辑按钮使用绝对定位悬浮在头像上
  - 使用CSS过渡效果实现平滑显示/隐藏

- 上传流程优化：
  - 先选择文件预览，确认后再上传
  - 使用Element Plus上传组件，但禁用自动上传
  - 手动控制上传流程，实现更好的用户体验

- 代码改进：
  - 使用Element Plus图标组件
  - 添加详细的错误处理和用户反馈
  - 优化样式结构，提高可维护性

## 2023-08-15：解决头像更新缓存问题

### 修改内容

1. 彻底解决头像缓存问题
   - 修改头像文件命名规则，添加时间戳确保文件名唯一
   - 修改`formatAvatarUrl`函数，始终添加版本号参数确保实时显示
   - 彻底解决"304 Not Modified"问题及更新后需要刷新页面的问题

2. 改进后端头像文件管理
   - 确保每个用户只保留一个头像文件
   - 新上传的头像会自动删除该用户的所有旧头像文件
   - 统一使用用户ID作为文件名，便于缓存控制

3. 优化日志记录
   - 为头像更新操作添加详细日志
   - 明确记录头像文件删除和创建过程

### 技术细节

- 缓存控制实现：
  - 调用`updateAvatarVersion()`生成新版本号，触发所有头像组件刷新
  - 始终在URL中添加版本号参数，确保头像实时更新
  - 避免浏览器缓存导致头像更新后不显示的问题

- 文件管理优化：
  - 后端删除用户目录下的所有旧头像文件
  - 根据Content-Type设置正确的文件扩展名
  - 文件命名规则：`uploads/avatars/{userId}/{userId}_{timestamp}.jpg|png|gif`
  - 使用时间戳确保每次上传都生成新文件，避免304缓存问题

- 代码改进：
  - 优化`formatAvatarUrl`和`updateAvatarVersion`函数
  - 添加更详细的注释说明缓存机制
  - 增强头像上传端点，优化文件管理

## 2023-08-06：修复顶部导航栏头像实时更新

### 修改内容

1. 添加导航栏头像实时更新机制
   - 添加全局事件通知机制，发布头像更新事件
   - 在顶部导航栏中添加事件监听，实现头像实时更新
   - 为导航栏头像添加缓存破坏机制，确保头像变更后立即显示

2. 优化mittBus事件总线调用
   - 修正mittBus导入方式，使用默认导出
   - 确保组件卸载时正确清理事件监听，避免内存泄漏
   - 实现组件间的可靠通信，解决头像更新不同步问题

### 技术细节

- 事件发布-订阅机制：
  - 头像上传成功后发布 'avatar-updated' 事件
  - 顶部导航栏监听事件并更新头像时间戳，触发重新渲染
  - 确保在组件卸载时正确移除事件监听器

- 组件间通信：
  - 使用全局事件总线解耦组件通信
  - 无需直接依赖，可在任何地方触发头像更新
  - 可扩展为其他需要实时更新的场景

## 2023-08-05：修复头像显示和上传问题

### 修改内容

1. 修复头像缓存问题
   - 添加时间戳参数破坏缓存，确保头像更新后立即显示
   - 使用计算属性 `avatarTimestamp` 在头像上传后强制刷新
   - 修改 `formattedAvatarUrl` 计算属性，支持URL查询参数

2. 优化上传逻辑
   - 确保每次打开对话框时清空文件选择
   - 只有选择了新头像文件时才调用上传API
   - 修复路径问题，支持 `/avatars` 和 `/uploads/avatars` 两种路径格式

3. 添加Vite配置代理
   - 添加对 `/avatars` 路径的代理配置
   - 将 `/avatars` 请求重写到 `/uploads/avatars`
   - 确保开发环境下静态资源正确加载

4. 修复格式化图片URL函数
   - 扩展 `formatImageUrl` 函数支持多种路径格式
   - 统一处理 `/uploads` 和 `/avatars` 开头的URL

### 技术细节

- 缓存破坏实现：
  - 为图片URL添加时间戳查询参数 `?_t=timestamp`
  - 上传成功后更新时间戳触发重新渲染
  - 避免浏览器缓存导致头像不更新问题

- 路径处理优化：
  - Vite代理配置处理不同路径格式
  - 前端适配多种路径格式，增强兼容性
  - 使用统一的格式化函数处理所有图片URL

## 2023-07-30：实时预览功能与头像优化

### 修改内容

1. 添加标签和个人介绍实时预览功能
   - 在用户输入时实时更新左侧个人信息卡片
   - 添加`previewData`响应式对象存储临时编辑数据
   - 通过`handleTagsChange`和`handleDescriptionChange`函数实现实时同步

2. 添加表单取消功能
   - 为基本设置和密码修改表单添加取消按钮
   - 取消编辑时恢复原始数据状态
   - 使用`originalForm`对象存储原始表单数据

3. 优化头像管理
   - 头像文件使用用户ID作为文件名，覆盖旧头像
   - 修改上传API，在同一用户目录中直接替换头像文件
   - 默认头像路径设置为"/uploads/avatars/default/default.jpeg"

4. 顶部导航栏显示用户真实头像
   - 修改art-header-bar组件，使用用户真实头像
   - 使用`formattedAvatarUrl`计算属性确保正确显示

### 技术细节

- 实时预览实现方式：
  - 使用Vue的响应式系统跟踪编辑变化
  - 数据仍在保存成功后才实际更新到后端
  - 保持用户界面的一致性和即时反馈

- 头像存储优化：
  - 后端存储路径：`uploads/avatars/{userId}/{userId}.jpg`
  - 重用用户ID作为文件名，减少存储冗余
  - 新建用户默认头像：`/uploads/avatars/default/default.jpeg`

- 用户体验改进：
  - 编辑状态下可随时取消修改
  - 实时预览提供即时视觉反馈
  - 整个页面使用一致的头像显示

## 2023-07-20：修复头像URL处理

### 修改内容

1. 添加图片URL格式化功能
   - 创建`formatImageUrl`工具函数，用于处理静态资源URL
   - 确保上传的头像文件可以正确显示

2. 配置静态资源访问
   - 在Vite配置中添加`/uploads`代理，指向后端服务器
   - 支持开发环境和生产环境下的静态资源访问

3. 优化头像上传流程
   - 修改头像预览和上传组件
   - 使用计算属性`formattedAvatarUrl`处理头像URL
   - 确保上传成功后正确更新本地头像URL

### 技术细节

- 后端将上传的文件保存在`uploads/avatars/{userId}/{timestamp}.jpg`
- 后端返回的路径格式为`/uploads/avatars/{userId}/{timestamp}.jpg`
- 前端通过代理或URL格式化函数访问这些静态资源
- 开发环境中使用Vite代理访问后端静态资源
- 生产环境中可以根据需要配置静态资源服务器

## 2023-07-18：修复头像上传API

### 修改内容

1. 修复头像上传API参数缺失问题
   - 添加`userId`参数到头像上传FormData中
   - 修改`uploadAvatar`函数签名，添加userId参数

2. 修正API调用
   - 在用户中心页面调用`UserService.uploadAvatar`时传入用户ID
   - 确保所有API调用使用正确的参数顺序

3. 更新文档
   - 修正文档中的API调用示例，确保参数顺序正确

### 技术细节

- 头像上传API需要两个参数：
  - `file`: 头像文件
  - `userId`: 用户ID
- 这两个参数都需要通过FormData传递
- 修改后的调用方式：`UserService.uploadAvatar(file, userId)`

## 2023-07-15：用户中心页面API优化

### 修改内容

1. 修改用户ID格式
   - 从数字ID改为使用`user_id`字符串格式
   - 所有API调用使用`user_id`作为唯一标识符

2. 用户信息安全性优化
   - 移除用户信息响应中的密码字段
   - 添加单独的修改密码API接口

3. 用户信息更新优化
   - 分离用户头像上传和用户信息更新
   - 添加用户标签和个人介绍字段

4. API调用方式优化
   - 使用统一的API调用方式
   - 优化错误处理和提示信息

### 技术细节

- 头像上传流程：
  1. 先上传头像文件到`/upload/avatar`
  2. 获取返回的头像路径
  3. 更新用户头像信息到`/users/{user_id}/avatar`

- 密码修改流程：
  1. 验证当前密码和新密码
  2. 调用`/users/{user_id}/password`接口更新密码
  3. 密码修改成功后清空表单

- 用户信息更新流程：
  1. 收集表单数据
  2. 调用`/users/{user_id}`接口更新用户信息
  3. 更新本地存储的用户信息

### 功能变更
- 分离了头像上传和用户信息更新的API调用
- 添加了用户标签功能，最多支持5个标签
- 添加了个人介绍字段，支持多行文本输入
- 优化了头像上传流程，先上传文件，再更新用户信息

### 技术实现
- 后端添加了新的API端点：`/users/{user_id}/avatar`
- 修改了上传头像API，使其不再自动更新用户信息
- 数据库添加了两个新字段：`tags`和`description`
- 创建了数据库迁移脚本，支持平滑升级

### UI/UX改进
- 头像编辑按钮现在只在鼠标悬停时显示
- 用户信息表单重新排列，更加合理
- 标签使用el-tag组件展示，支持添加和删除
- 个人介绍使用多行文本框，支持更详细的自我介绍

### 代码优化
- 使用TypeScript接口定义API请求和响应类型
- 重构了UserService类，添加了新的方法
- 优化了错误处理和用户反馈
- 添加了详细的代码注释 