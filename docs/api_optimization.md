# API 优化与数据库结构统一

本文档总结了对前后端交互API和数据库结构的优化，确保前后端一致性和良好的用户体验。

## 主要优化内容

1. 为所有主要实体添加了唯一标识字段，格式为"前缀+7位随机字符"
2. 统一了所有状态字段为整数类型，提高了性能和可维护性
3. 分离了头像上传和用户信息更新API，提高了灵活性
4. 添加了用户标签和个人介绍字段，丰富了用户资料
5. 创建了通用的ID生成函数，确保唯一性和一致性
6. 创建了数据库迁移脚本，支持平滑升级
7. 编写了API类型定义文档，确保前后端一致性

## 唯一标识字段

为以下实体添加了唯一标识字段：

| 实体 | 字段名 | 格式 | 示例 |
|------|--------|------|------|
| 用户 | user_id | user + 7位随机字符 | user1Ab2Cd3 |
| 组织 | org_id | org + 7位随机字符 | org1Ab2Cd3 |
| 虚拟组织 | vorg_id | vorg + 7位随机字符 | vorg1Ab2Cd3 |
| 视频流 | stream_id | stream + 7位随机字符 | stream1Ab2Cd3 |
| 算法 | algo_id | algo + 7位随机字符 | algo1Ab2Cd3 |
| 警告 | warn_id | warn + 7位随机字符 | warn1Ab2Cd3 |
| 监控任务 | task_id | task + 7位随机字符 | task1Ab2Cd3 |

## 状态字段统一

将所有状态字段从字符串类型转换为整数类型：

### 视频流状态

| 值 | 原状态 | 新状态 |
|----|--------|--------|
| 0 | offline | 离线 |
| 1 | online | 在线 |
| 2 | error | 异常 |

### 监控任务状态

| 值 | 原状态 | 新状态 |
|----|--------|--------|
| 0 | stopped | 停止 |
| 1 | running | 运行中 |
| 2 | error | 异常 |

### 警告级别

| 值 | 原级别 | 新级别 |
|----|--------|--------|
| 1 | info | 普通 |
| 2 | warning | 重要 |
| 3 | critical | 紧急 |

### 警告状态

| 值 | 状态 |
|----|------|
| 0 | 未处理 |
| 1 | 已处理 |
| 2 | 误报 |
| 3 | 忽略 |

### 算法状态

| 值 | 状态 |
|----|------|
| 0 | 禁用 |
| 1 | 启用 |
| 2 | 测试中 |

## API 分离

分离了头像上传和用户信息更新API：

1. 上传头像API：`POST /upload/avatar`
   - 仅负责文件上传，不更新用户信息
   - 返回上传后的头像路径

2. 更新用户头像API：`PUT /users/{user_id}/avatar`
   - 更新用户头像路径
   - 接收参数：`{ avatar: string }`

3. 更新用户信息API：`PUT /users/{user_id}`
   - 更新用户基本信息
   - 接收参数：用户信息对象（不包含头像）

## 数据库迁移脚本

创建了两个数据库迁移脚本：

1. `add_unique_ids.py`：为各表添加唯一标识字段
2. `update_status_fields.py`：更新状态字段为整数类型

这些脚本支持平滑升级，不会破坏现有数据。

## 前端适配

1. 更新了前端API调用逻辑，支持分离的头像上传和用户信息更新
2. 添加了标签和个人介绍字段的处理
3. 更新了类型定义，确保与后端一致

## 运行迁移

要应用这些更改，需要运行以下命令：

```bash
cd backend
python run_migration.py
```

或者使用提供的批处理文件：

```bash
# Windows
migrate.bat

# Linux/Mac
chmod +x migrate.sh
./migrate.sh
```

## 注意事项

1. API路径中的ID参数现在支持两种格式：
   - 数字ID：`/users/1`
   - 唯一标识：`/users/user1Ab2Cd3`

2. 前端应优先使用唯一标识而非数字ID，以提高安全性

3. 用户标签最多支持5个，个人介绍最长支持500个字符

## 用户相关API优化

1. **用户信息响应不包含密码字段**
   - 安全性考虑，API响应中不应返回密码相关字段
   - 即使是加密后的密码也不应在API响应中出现

2. **分离用户头像上传和信息更新**
   - 上传头像：`POST /upload/avatar`（仅负责文件上传）
   - 更新用户头像：`PUT /users/{user_id}/avatar`（更新用户头像信息）
   - 更新用户信息：`PUT /users/{user_id}`（更新其他用户信息）

3. **添加单独的修改密码接口**
   - 修改密码：`PUT /users/{user_id}/password`
   - 请求体包含当前密码和新密码
   - 普通用户需要验证当前密码，管理员可以直接修改 